<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLC Synchronization Application Manual</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 20px; }
        h1, h2, h3 { color: blue; }
        code { background-color: #f4f4f4; padding: 2px 5px; border-radius: 3px; }
        pre { background-color: #f4f4f4; padding: 10px; border-radius: 5px; overflow: auto; }
    </style>
</head>
<body>
    <h1>PLC Synchronization Application Manual</h1>
    <p>This manual provides instructions on how to use the PLC Synchronization Application, which facilitates communication between multiple PLCs by reading and writing data blocks, handling synchronization, and managing heartbeats.</p>

    <h2>Purpose of the Application</h2>
    <p>The PLC Synchronization Application is designed to facilitate communication between multiple Programmable Logic Controllers (PLCs) in an industrial environment. The application reads data from PLCs, synchronizes it across other PLCs, and ensures consistent state management by using heartbeat signals to verify the status of each PLC. This ensures that a controlling PLC can verify that a command has been executed correctly by the receiving PLC, and vice versa.</p>

    <h2>Installation</h2>
    <p>To install and run the PLC Synchronization Application, follow these steps:</p>

    <h3>1. Prerequisites</h3>
    <p>Ensure that you have Node.js and npm installed on your system. You can download and install them from <a href="https://nodejs.org/" target="_blank">nodejs.org</a>.</p>

    <h3>2. Install Dependencies</h3>
    <p>Navigate to the directory where your application files are located and run the following command to install the required modules:</p>
    <pre><code>npm install</code></pre>
    <p>The application requires the following Node.js modules:</p>
    <ul>
        <li><code>fs</code>: File system operations.</li>
        <li><code>nodes7</code>: Communication with Siemens PLCs.</li>
        <li><code>express</code>: Web framework for serving the HTTP interface.</li>
        <li><code>jsonc-parser</code>: Parsing JSON with comments.</li>
        <li><code>winston</code>: Logging library for detailed logs.</li>
        <li><code>winston-daily-rotate-file</code>: Log rotation for maintaining daily log files.</li>
    </ul>

    <h3>3. Running the Application</h3>
    <p>To start the application, use the following command:</p>
    <pre><code>node app.js</code></pre>

    <h2>Configuration File (config.json)</h2>
    <p>The <code>config.json</code> file is used to configure the application settings and define the PLCs involved in the synchronization process. Below is an example of the configuration file and an explanation of its fields.</p>

    <pre><code>{
  "operationInterval": 2000,
  "maxReconnectAttempts": 10,
  "reconnectInterval": 5000,
  "heartbeatOffset": 8,
  "httpPort": 3010,
  "plcs": [
    {
      "name": "PLC_SERVER",
      "ip": "192.168.178.190",
      "rack": 0,
      "slot": 1,
      "syncDbOffset": 0,
      "syncDbNumber": 200,
      "dbNumber": 17,
      "variables": {
        "cip_pump_speed_control": { "type": "INT", "offset": 0 },
        "heartbeat": { "type": "INT", "offset": 2 }
      }
    },
    {
      "name": "PLC_H150",
      "ip": "192.168.178.184",
      "rack": 0,
      "slot": 1,
      "syncDbOffset": 4,
      "syncDbNumber": 200,
      "dbNumber": 17,
      "variables": {
        "cip_pump_speed_state": { "type": "INT", "offset": 0 },
        "heartbeat": { "type": "INT", "offset": 2 }
      }
    }
  ]
}</code></pre>

    <h3>Explanation of Configuration Fields</h3>
    <ul>
        <li><strong>operationInterval</strong>: Interval (in milliseconds) at which the program performs read and write operations for all PLCs.</li>
        <li><strong>maxReconnectAttempts</strong>: The maximum number of reconnection attempts for each PLC before giving up.</li>
        <li><strong>reconnectInterval</strong>: Interval (in milliseconds) between reconnection attempts.</li>
        <li><strong>heartbeatOffset</strong>: The offset used for the server heartbeat variable in the synchronization data block.</li>
        <li><strong>httpPort</strong>: Port number on which the Express server will run to serve the HTTP interface.</li>
        <li><strong>plcs</strong>: Array of PLC configurations:</li>
        <ul>
            <li><strong>name</strong>: Unique name of the PLC.</li>
            <li><strong>ip</strong>: IP address of the PLC.</li>
            <li><strong>rack</strong>: Rack number of the PLC.</li>
            <li><strong>slot</strong>: Slot number of the PLC.</li>
            <li><strong>syncDbOffset</strong>: Offset for the data in the synchronization block for each PLC.</li>
            <li><strong>syncDbNumber</strong>: Data block number used for synchronizing data for each specific PLC.</li>
            <li><strong>dbNumber</strong>: Data block number used for reading from each specific PLC.</li>
            <li><strong>variables</strong>: List of variables for each PLC:</li>
            <ul>
                <li><strong>type</strong>: Data type of the variable (e.g., <code>INT</code>, <code>BOOL</code>, <code>REAL</code>).</li>
                <li><strong>offset</strong>: Offset of the variable within the data block.</li>
            </ul>
        </ul>
    </ul>

    <h3>Examples of Variable Definitions</h3>
    <p>Below are examples of how to define different types of variables:</p>
    <ul>
        <li><strong>Integer (INT)</strong>: <code>"cip_pump_speed_control": { "type": "INT", "offset": 0 }</code></li>
        <li><strong>Boolean (BOOL)</strong>: <code>"pump_active": { "type": "BOOL", "byte": 3, "bit": 0 }</code></li>
        <li><strong>Real (REAL)</strong>: <code>"temperature": { "type": "REAL", "offset": 4 }</code></li>
        <li><strong>Array of Integers</strong>: <code>"pressure_values": [ { "type": "INT", "offset": 6 }, { "type": "INT", "offset": 8 } ]</code></li>
    </ul>

    <h2>Running the Application with PM2</h2>
    <p>PM2 is a process manager for Node.js applications that allows you to keep your application running, restart it on failure, and ensure it starts on boot. Below are instructions on how to set up PM2 to run the PLC Synchronization Application:</p>

    <h3>Install PM2</h3>
    <p>First, install PM2 globally using npm:</p>
    <pre><code>npm install -g pm2</code></pre>

    <h3>Start the Application with PM2</h3>
    <p>Navigate to the directory where your application is located and start it with PM2:</p>
    <pre><code>pm2 start app.js --name "plc-sync-app"</code></pre>
    <p>The <code>--name</code> flag assigns a custom name to your process, making it easier to manage.</p>

    <h3>Save the PM2 Process List</h3>
    <p>To ensure that your application restarts on system reboot, save the PM2 process list:</p>
    <pre><code>pm2 save</code></pre>

    <h3>Set Up PM2 to Start on Boot</h3>
    <p>To configure PM2 to start on system boot, use the following command:</p>
    <pre><code>pm2 startup</code></pre>
    <p>Follow the instructions provided by the command to complete the setup.</p>

    <h2>HTTP Interface</h2>
    <p>The application provides an HTTP interface that allows you to access the combined data and various counters. By default, it runs on the port specified in the configuration file.</p>
    <h3>Endpoints</h3>
    <ul>
        <li><strong>/data</strong>: Provides the current synchronized data along with the server heartbeat, read counters, write counters, and a link to the manual.</li>
        <li><strong>/manual</strong>: Provides access to the online manual for the application.</li>
    </ul>

</body>
</html>

